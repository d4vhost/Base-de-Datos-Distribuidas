#SCRIPT TABLAS FLOTILLA AUTOS
CREATE ROLE empresa_viajes WITH LOGIN PASSWORD 'VIAJES123';
GRANT CONNECT ON DATABASE empresa_viajes TO empresa_viajes;
GRANT ALL PRIVILEGES ON DATABASE empresa_viajes TO empresa_viajes;

-- Crear las tablas
CREATE TABLE VEHICULO (
    ID_VEH INT IDENTITY(1,1) PRIMARY KEY,
    MAR_VEH VARCHAR(10) NOT NULL,
    MOD_VEH VARCHAR(10) NOT NULL,
    AÑO_VEH INT NOT NULL,
    ESTADO_DISP CHAR(1)
);

CREATE TABLE DOCUMENTOS (
    ID_DOC INT IDENTITY(1,1) PRIMARY KEY,
    TIP_DOC VARCHAR(10) NOT NULL,
    FEC_EXP_DOC DATE NOT NULL,
    ID_VEH_PER INT NOT NULL,
    FOREIGN KEY (ID_VEH_PER) REFERENCES VEHICULO(ID_VEH)
);

CREATE TABLE CONDUCTORES (
    ID_CONDUCTOR INT IDENTITY(1,1) PRIMARY KEY,
    NOM_CON VARCHAR(10) NOT NULL,
    LIC_CON VARCHAR(10) NOT NULL,
    FEC_VEN_LIC DATE NOT NULL,
    ID_VEH_CON INT NOT NULL,
    FOREIGN KEY (ID_VEH_CON) REFERENCES VEHICULO(ID_VEH)
);

CREATE TABLE MANTENIMIENTOS (
    ID_MAN INT IDENTITY(1,1) PRIMARY KEY,
    LIC_CON VARCHAR(10) NOT NULL,
    FEC_VEN_LIC DATE NOT NULL,
    ID_VEH_PER INT NOT NULL,
    FOREIGN KEY (ID_VEH_PER) REFERENCES VEHICULO(ID_VEH)
);

CREATE TABLE GASOLINA (
    ID_GAS INT IDENTITY(1,1) PRIMARY KEY,
    TIP_GAS VARCHAR(10) NOT NULL,
    DES_GAS VARCHAR(50) NOT NULL,
    PRECIO_X_GALON DECIMAL(10,2) NOT NULL,
    ID_VEH_PER INT NOT NULL,
    FOREIGN KEY (ID_VEH_PER) REFERENCES VEHICULO(ID_VEH)
);

CREATE TABLE RUTAS (
    ID_RUT INT IDENTITY(1,1) PRIMARY KEY,
    FEC_RUT DATE NOT NULL,
    ORI_RUT_VIA VARCHAR(10) NOT NULL,
    DES_RUT_VIA VARCHAR(10) NOT NULL,
    DIS_RRE_KM DECIMAL(10,2) NOT NULL,
    DUR_EST_VIA DECIMAL(10,2) NOT NULL,
    ID_VEH_PER INT NOT NULL,
    FOREIGN KEY (ID_VEH_PER) REFERENCES VEHICULO(ID_VEH)
);

-- Insertar datos en VEHICULO
INSERT INTO VEHICULO (MAR_VEH, MOD_VEH, AÑO_VEH, ESTADO_DISP) VALUES
('Toyota', 'Corolla', 2020, 'A'),
('Ford', 'Focus', 2018, 'B'),
('Honda', 'Civic', 2019, 'A'),
('Chevrolet', 'Malibu', 2021, 'A'),
('Nissan', 'Sentra', 2022, 'B');

-- Insertar datos en DOCUMENTOS
INSERT INTO DOCUMENTOS (TIP_DOC, FEC_EXP_DOC, ID_VEH_PER) VALUES
('Seguro', '2023-01-10', 1),
('Permiso', '2023-02-15', 2),
('Licencia', '2023-03-20', 3),
('Inspección', '2023-04-25', 4),
('Registro', '2023-05-30', 5);

-- Insertar datos en CONDUCTORES
INSERT INTO CONDUCTORES (NOM_CON, LIC_CON, FEC_VEN_LIC, ID_VEH_CON) VALUES
('Juan', 'ABC123', '2025-01-10', 1),
('Maria', 'DEF456', '2025-02-15', 2),
('Carlos', 'GHI789', '2025-03-20', 3),
('Ana', 'JKL012', '2025-04-25', 4),
('Pedro', 'MNO345', '2025-05-30', 5);

-- Insertar datos en MANTENIMIENTOS
INSERT INTO MANTENIMIENTOS (LIC_CON, FEC_VEN_LIC, ID_VEH_PER) VALUES
('ABC123', '2025-01-10', 1),
('DEF456', '2025-02-15', 2),
('GHI789', '2025-03-20', 3),
('JKL012', '2025-04-25', 4),
('MNO345', '2025-05-30', 5);

-- Insertar datos en GASOLINA
INSERT INTO GASOLINA (TIP_GAS, DES_GAS, PRECIO_X_GALON, ID_VEH_PER) VALUES
('Regular', 'Gasolina sin plomo', 3.50, 1),
('Premium', 'Alto octanaje', 4.00, 2),
('Diesel', 'Combustible pesado', 3.80, 3),
('Regular', 'Económico', 3.40, 4),
('Premium', 'Máximo rendimiento', 4.20, 5);

-- Insertar datos en RUTAS
INSERT INTO RUTAS (FEC_RUT, ORI_RUT_VIA, DES_RUT_VIA, DIS_RRE_KM, DUR_EST_VIA, ID_VEH_PER) VALUES
('2023-06-10', 'Ciudad A', 'Ciudad B', 100.5, 2.5, 1),
('2023-07-15', 'Ciudad C', 'Ciudad D', 150.0, 3.0, 2),
('2023-08-20', 'Ciudad E', 'Ciudad F', 200.7, 4.5, 3),
('2023-09-25', 'Ciudad G', 'Ciudad H', 250.3, 5.0, 4),
('2023-10-30', 'Ciudad I', 'Ciudad J', 300.8, 6.5, 5);



#Trigger del control de vencimiento de licencia de un conductor
CREATE TRIGGER trg_CheckLicenseExpiration
ON CONDUCTORES
AFTER INSERT, UPDATE
AS
BEGIN
    DECLARE @FEC_VEN_LIC DATE;
    DECLARE @NOM_CON VARCHAR(10);
    SELECT @FEC_VEN_LIC = i.FEC_VEN_LIC, @NOM_CON = i.NOM_CON
    FROM inserted i;
    IF @FEC_VEN_LIC <= GETDATE()
    BEGIN
        RAISERROR ('La licencia del conductor %s está vencida y no se puede insertar o actualizar el registro.', 16, 1, @NOM_CON);
        ROLLBACK TRANSACTION;
    END
END;




